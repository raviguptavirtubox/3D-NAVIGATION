<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Live AR Hospital Navigation</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; }
        
        /* The Live Camera Feed */
        #video-bg {
            position: fixed; right: 0; bottom: 0;
            min-width: 100%; min-height: 100%;
            z-index: 1; filter: brightness(0.7);
        }

        /* The 360 Overlay (Visual SLAM Reference) */
        #panorama {
            position: fixed; top: 10px; right: 10px;
            width: 120px; height: 120px;
            border-radius: 50%; border: 3px solid #fff;
            z-index: 10; opacity: 0.9; pointer-events: none;
        }

        /* Navigation Instructions */
        #ui-layer {
            position: absolute; bottom: 30px; left: 0; right: 0;
            z-index: 20; display: flex; flex-direction: column; align-items: center;
        }

        .instruction-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px; border-radius: 20px; width: 80%;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .ar-arrow {
            font-size: 80px; color: #007AFF;
            text-shadow: 0 0 20px rgba(255,255,255,0.8);
            margin-bottom: 10px; transition: transform 0.3s ease;
        }
    </style>
</head>
<body>

    <video id="video-bg" autoplay playsinline></video>

    <div id="panorama"></div>

    <div id="ui-layer">
        <div class="ar-arrow" id="main-arrow">â†‘</div>
        <div class="instruction-card">
            <h2 id="step-title">Following Route...</h2>
            <p id="step-desc">Point your phone down the hallway to begin.</p>
        </div>
    </div>

<script>
    // --- DATA CONFIGURATION ---
    const navData = {
        "Kiosk_A": {
            pano: "https://static.virtubox.io/catalog/file/20260202-090353-wnku-start.jpg", // Replace with your 360 img link
            instruction: "Walk toward the Pharmacy",
            rotation: 0, 
            next: "Hallway_1"
        },
        "Hallway_1": {
            pano: "https://static.virtubox.io/catalog/file/20260202-090351-mi0w-middle.jpg",
            instruction: "Turn Left at the elevators",
            rotation: -90,
            next: "Cardiology"
        },

        "Kiosk_B": {
            pano: "https://static.virtubox.io/catalog/file/20260202-090348-vx8f-end.jpg",
            instruction: "Turn Left at the elevators",
            rotation: -90,
            next: "Cardiology"
        }
    };

    // --- STEP 1: START LIVE CAMERA ---
    async function startCamera() {
        const video = document.getElementById('video-bg');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" }, 
                audio: false 
            });
            video.srcObject = stream;
        } catch (err) {
            console.error("Camera error: ", err);
            alert("Please allow camera access for AR navigation.");
        }
    }

    // --- STEP 2: INITIALIZE 360 OVERLAY ---
    const params = new URLSearchParams(window.location.search);
    const startNode = params.get('from') || "Kiosk_A";
    
    const viewer = pannellum.viewer('panorama', {
        "type": "equirectangular",
        "panorama": navData[startNode].pano,
        "autoLoad": true,
        "showControls": false
    });

    // --- STEP 3: SENSOR LOGIC (Simulated SLAM) ---
    // This rotates the arrow based on the phone's physical orientation
    function handleOrientation(event) {
        if (event.alpha !== null) {
            const compass = event.alpha; // Compass heading
            const arrow = document.getElementById('main-arrow');
            
            // Adjust the arrow based on the destination rotation
            const targetRotation = navData[startNode].rotation;
            arrow.style.transform = `rotate(${compass + targetRotation}deg)`;
        }
    }

    // --- STEP 4: UI UPDATES ---
    function initNav() {
        const node = navData[startNode];
        document.getElementById('step-title').innerText = "Target: " + params.get('to');
        document.getElementById('step-desc').innerText = node.instruction;
        
        // Request Permission for Orientation (Required for iOS)
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
                .then(state => {
                    if (state === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation);
                    }
                });
        } else {
            window.addEventListener('deviceorientation', handleOrientation);
        }
    }

    // Initialize everything
    window.onload = () => {
        startCamera();
        initNav();
    };
</script>
</body>
</html>
